#!/usr/bin/env ruby
require 'unicorn-cuba-base'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

Application.new('httpimagestore', port: 3000) do
	cli do
		description 'HTTP based image storage and thumbnailer'
		argument :config,
			cast: Pathname,
			description: 'configuration file path'
		version (Pathname.new(__FILE__).dirname + '..' + 'VERSION').read
	end

	settings do |settings|
		Controler.settings[:config_file] = settings.config
	end

	main do |settings|
		class HTTPImageStore < Controler
			require 'httpimagestore/error_reporter'

			self.define do
				on error? do
					run ErrorReporter
				end

				env['app.configuration'].handlers.each do |handler|
					on eval(handler.http_method), *handler.uri_matchers do |*args|
						locals = {
							path: env["PATH_INFO"][1..-1]
						}.merge Hash[handler.uri_matchers.select{|m| m.is_a? Symbol}.zip(args)]
						state = Configuration::RequestState.new(req.body.read, locals)

						handler.image_sources.each do |image_sources|
							image_sources.realize(state)
						end
						handler.stores.each do |store|
							store.realize(state)
						end
						handler.output.realize(state)

						instance_eval &state.output_callback
					end
				end

				on 'health_check' do
					log.info "health_check"
					write_plain 200, 'OK'
				end

				on root do
					write_plain 200, 'HTTP Image Store'
				end
			end
		end

		class Configurator
			def initialize(app, configuration)
				@app = app
				@configuration = configuration
			end

			def call(env)
				env['app.configuration'] = @configuration
				@app.call(env)
			end
		end

		require 'httpimagestore/configuration'

		# connect Scope tree with Controler logger
		Configuration::Scope.logger = Controler.logger_for(Configuration::Scope)

		# load builin supported set
		require 'httpimagestore/configuration/path'
		require 'httpimagestore/configuration/handler'
		require 'httpimagestore/configuration/thumbnailer'
		require 'httpimagestore/configuration/file'
		require 'httpimagestore/configuration/output'
		require 'httpimagestore/configuration/s3'

		HTTPImageStore.use Configurator, Configuration.from_file(settings.config)
		HTTPImageStore
	end
end

