#!/usr/bin/ruby

require 'sinatra/base'
require 'pathname'
require 's3'
require 'httpthumbnailer-client'
require 'digest/sha2'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'httpimagestore/configuration'
require 'httpimagestore/pathname'

sinatra = Sinatra.new

sinatra.set :environment, 'production'
sinatra.set :server, ['mongrel']
sinatra.set :lock, true
sinatra.set :logging, true

Configuration.new do
	s3_key 'AKIAJMUYVYOSACNXLPTQ', 'MAeGhvW+clN7kzK3NboASf3/kZ6a81PRtvwMZj4Y'
	s3_bucket 'rhthumbnails'

	thumbnail_class 'small', 'crop', 128, 128
	thumbnail_class 'tiny', 'crop', 32, 32
end.put(sinatra)

class S3Put
	def initialize(key_id, key_secret, bucket, options = {})
		@options = options
		@logger = (options[:logger] or Logger.new('/dev/null'))

		@s3 = S3::Service.new(:access_key_id => key_id, :secret_access_key => key_secret)

		@logger.info "Getting bucket: #{bucket}"
		@bucket = @s3.buckets.find(bucket) or fail "no buckte '#{bucket}' found"
	end

	def put_image(image_path, content_type, data)
		@logger.info "Putting image in bucket '#{@bucket.name}': #{image_path}"

		file = @bucket.objects.build(image_path)
		file.content_type = content_type
		file.content = data
		file.save

		image_path
	end
end

sinatra.before do
	# singletons
	@s3 ||= S3Put.new(settings.s3_key_id, settings.s3_key_secret, settings.s3_bucket, :logger => logger)
	@thumbnailer ||= HTTPThumbnailerClient.new(settings.thumbnailer_url)
end

sinatra.helpers do
	def plain_exception(exception)
		headers "Content-Type" => "text/plain"
		body "Error: #{exception.class.name}: #{exception}\n"
	end

	def digest(data)
		Digest::SHA2.new.update(data).to_s[0,16]
	end
end

sinatra.get '/' do
	"hello"
end

sinatra.put %r{/thumbnail/([^/]*)/(.*)} do |classes, image_path|
	urls = []

	classes = classes.split(',').map{|tc| settings.thumbnail_classes[tc] or fail "Class '#{tc}' not configured"}
	image = request.body.read
	image_hash = digest(image)

	urls << @s3.put_image(Pathname.new(image_path).original_image(image_hash).to_s, response.headers['Content-Type'], image)

	thumbs = @thumbnailer.thumbnail(image) do
		classes.each do |tc|
			thumbnail tc.method, tc.width, tc.height, tc.format, tc.options
		end
	end

	thumbs.zip(classes).each do |thumb, thumbnail_class|
		urls << @s3.put_image(Pathname.new(image_path).thumbnail_image(image_hash, thumbnail_class.name).to_s, thumb.mime_type, thumb.data)
	end

	return urls.join("\n")
end

sinatra.error do
	plain_exception(env['sinatra.error'])
end

sinatra.run!

