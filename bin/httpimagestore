#!/usr/bin/env ruby
require 'unicorn-cuba-base'

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

Application.new('httpimagestore', port: 3000) do
	cli do
		description 'HTTP based image storage and thumbnailer'
		option :upload_retry_time,
			default: 2,
			cast: Integer,
			description: 'keep retrying uploads until that time in seconds has passed'
		option :upload_retry_initial_delay,
			default: 0.1,
			cast: Float,
			description: 'initial retry delay that will be multiplied by 2 each retry cycle'
		argument :config,
			cast: Pathname,
			description: 'configuration file path'
		version (Pathname.new(__FILE__).dirname + '..' + 'VERSION').read
	end

	settings do |settings|
		Controler.settings[:upload_retry_times] = settings.upload_retry_times
		Controler.settings[:upload_retry_delay] = settings.upload_retry_delay

		Controler.settings[:config_file] = settings.config
	end

	main do |settings|
		class HTTPImageStore < Controler
			require 'httpimagestore/error_reporter'

			self.define do
				on error? do
					run ErrorReporter
				end

				env['app.configuration'].handlers.each do |handler|
					on eval(handler.http_method), *handler.uri_matchers do |*args|
						locals = Hash[*handler.uri_matchers.select{|m| m.is_a? Symbol}.zip(args).flatten]
						state = Configuration::RequestState.new(req.body.read, locals)

						handler.image_sources.each do |image_sources|
							image_sources.realize(state)
						end
						handler.stores.each do |store|
							store.realize(state)
						end
						handler.output.realize(state)

						instance_eval &state.output_callback
					end
				end

				on 'health_check' do
					log.info "health_check"
					write_plain 200, 'OK'
				end

				on root do
					write_plain 200, 'HTTP Image Store'
				end
			end
		end

		class Configurator
			def initialize(app, configuration)
				@app = app
				@configuration = configuration
			end

			def call(env)
				env['app.configuration'] = @configuration
				@app.call(env)
			end
		end

		require 'httpimagestore/configuration'

		HTTPImageStore.use Configurator, Configuration.from_file(settings.config)
		HTTPImageStore
	end
end

